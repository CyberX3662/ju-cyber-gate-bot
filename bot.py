import os
import telebot
import requests
from github import Github
from openai import OpenAI
from flask import Flask
from threading import Thread

# ======================
# ENV VARIABLES
# ======================

BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_KEY")
GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")

# ======================
# CLIENTS
# ======================

client = OpenAI(api_key=OPENAI_KEY)
g = Github(GITHUB_TOKEN)
repo = g.get_repo("CyberX3662/JU-Cyber-Gate")

bot = telebot.TeleBot(BOT_TOKEN)

# ======================
# START COMMAND
# ======================

@bot.message_handler(commands=["start"])
def start(message):
    bot.reply_to(
        message,
        "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!\n\nØ£Ø±Ø³Ù„ Ù…Ù„Ù PDF Ø£Ùˆ Word ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªÙ„Ø®ÙŠØµÙ‡ + Ø¥Ù†Ø´Ø§Ø¡ ÙÙ„Ø§Ø´ ÙƒØ§Ø±Ø¯ ÙˆØ£Ø³Ø¦Ù„Ø© ÙˆØ±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ GitHub."
    )

# ======================
# FILE HANDLER
# ======================

@bot.message_handler(content_types=["document"])
def handle_file(message):
    try:
        bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡...")

        file_info = bot.get_file(message.document.file_id)
        file_url = f"https://api.telegram.org/file/bot{BOT_TOKEN}/{file_info.file_path}"

        file_bytes = requests.get(file_url).content
        text = file_bytes.decode("utf-8", errors="ignore")[:4000]

        prompt = f"""
Summarize this lecture in Arabic and English.
Create flashcards and quiz questions.

{text}
"""

        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}]
        )

        content = response.choices[0].message.content

        path = "AutoGenerated/Week.md"

        try:
            old = repo.get_contents(path)
            repo.update_file(path, "update file", content, old.sha)
        except:
            repo.create_file(path, "create file", content)

        bot.reply_to(message, "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ + ÙÙ„Ø§Ø´ ÙƒØ§Ø±Ø¯ + Ø£Ø³Ø¦Ù„Ø© ÙˆØ±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ GitHub")

    except Exception as e:
        bot.reply_to(message, f"âŒ Ø­ØµÙ„ Ø®Ø·Ø£:\n{e}")

# ======================
# KEEP ALIVE SERVER
# ======================

app = Flask("")

@app.route("/")
def home():
    return "Bot is running..."

def run():
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 10000)))

def keep_alive():
    t = Thread(target=run)
    t.start()

keep_alive()

# ======================
# START BOT
# ======================

bot.infinity_polling(skip_pending=True)
